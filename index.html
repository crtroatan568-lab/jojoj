<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Ventas</title>
<style>
  body { font-family: Arial; margin: 40px; color: #333; }
  h1 { color: #4A148C; margin-bottom: 10px; }
  .empresa-card {
    background: #ede7f6;
    border-radius: 10px;
    box-shadow: 0 2px 8px #ddd;
    padding: 18px 24px;
    margin-bottom: 18px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 18px;
    font-size: 16px;
  }
  .empresa-card span {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
  }
  .empresa-label {
    color: #6A1B9A;
    font-weight: bold;
    margin-right: 4px;
  }
  .filtros-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    background: #f4f4f4;
    border-radius: 8px;
    padding: 12px 18px;
    margin-bottom: 18px;
    box-shadow: 0 1px 4px #eee;
  }
  .filtros-bar label {
    font-weight: 500;
    color: #4A148C;
    margin-right: 4px;
  }
  .filtros-bar input[type="date"] {
    padding: 7px 10px;
    border-radius: 5px;
    border: 1px solid #bbb;
    font-size: 15px;
    margin-right: 8px;
  }
  .filtros-bar button {
    padding: 8px 18px;
    background: #6A1B9A;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    margin-right: 4px;
    transition: background 0.2s;
  }
  .filtros-bar button:hover {
    background: #4A148C;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 8px #eee; }
  th, td { border: 1px solid #ccc; padding: 8px 10px; font-size: 14px; }
  th { background: linear-gradient(90deg, #6A1B9A 60%, #8E24AA 100%); color: #fff; }
  tr.total-row { background: #ede7f6; font-weight: bold; }
  .totales { margin-top: 20px; font-weight: bold; background: #ede7f6; padding: 12px; border-radius: 6px; box-shadow: 0 1px 4px #ddd; }
  @media print {
    form, button { display: none !important; }
    body { margin: 0; }
    .totales { page-break-inside: avoid; }
    table { page-break-inside: avoid; }
    /* Orientación horizontal */
    @page {
      size: A4 landscape;
      margin: 10mm;
      /* Escala al 50% */
      zoom: 0.5;
    }
    /* Mantener colores en impresión */
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }
  }
</style>
</head>
<body>

<h1>REPORTE DE VENTAS</h1>

<div id="empresa-info" style="margin-bottom:18px; background:#ede7f6; padding:12px; border-radius:6px; box-shadow:0 1px 4px #ddd;">
<div class="empresa-card">
  <span><span class="empresa-label">EMPRESA:</span> <span id="nombre-negocio"></span></span>
  <span><span class="empresa-label">RTN:</span> <span id="rtn"></span></span>
  <span><span class="empresa-label">EMAIL:</span> <span id="correo"></span></span>
  <span><span class="empresa-label">TELÉFONO:</span> <span id="telefono"></span></span>
  <span style="flex:1 1 100%;"><span class="empresa-label">DIRECCIÓN:</span> <span id="direccion"></span></span>
</div>

<div>
<div class="filtros-bar">
  <label for="fechaDesde">Desde:</label>
  <input type="date" id="fechaDesde">
  <label for="fechaHasta">Hasta:</label>
  <input type="date" id="fechaHasta">
  <button onclick="cargarReporte()">Filtrar</button>
  <button onclick="window.print()">Imprimir / PDF</button>
</div>

<div id="reporte">
  <p>Seleccione un rango de fechas y presione "Filtrar" para ver el reporte.</p>
</div>

<script>
// Obtener parámetros de la URL
function getParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name) || '';
}

const appId = getParam('id');
const apiKey = getParam('key');
const tableVenta = 'VENTA';
const tableConfig = 'CONFIGURACIONES';

async function cargarReporte() {
  const desde = document.getElementById('fechaDesde').value;
  const hasta = document.getElementById('fechaHasta').value;
  const contenedor = document.getElementById('reporte');

  if (!appId || !apiKey) {
    contenedor.innerHTML = '<p style="color:red">Faltan parámetros en la URL: id y key</p>';
    return;
  }
  contenedor.innerHTML = "<p>Cargando...</p>";

  try {
    // Consulta datos de empresa (CONFIGURACIONES)
    const resConfig = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableConfig}/Action`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ApplicationAccessKey': apiKey
      },
      body: JSON.stringify({ Action: "Find", Properties: {}, Rows: [] })
    });
    const configData = await resConfig.json();
    let empresa = {
      "NOMBRE DEL NEGOCIO": "",
      "RTN": "",
      "CORREO ELECTRONICO": "",
      "TELEFONO": "",
      "DIRECCION DE MI NEGOCIO": ""
    };
    if (Array.isArray(configData) && configData.length > 0) {
      // Toma la primera fila de la tabla CONFIGURACIONES
      empresa["NOMBRE DEL NEGOCIO"] = configData[0]["NOMBRE DEL NEGOCIO"] || "";
      empresa["RTN"] = configData[0]["RTN"] || "";
      empresa["CORREO ELECTRONICO"] = configData[0]["CORREO ELECTRONICO"] || "";
      empresa["TELEFONO"] = configData[0]["TELEFONO"] || "";
      empresa["DIRECCION DE MI NEGOCIO"] = configData[0]["DIRECCION DE MI NEGOCIO"] || "";
    }
    // Mostrar datos en el HTML
    document.getElementById('nombre-negocio').textContent = empresa["NOMBRE DEL NEGOCIO"];
    document.getElementById('rtn').textContent = empresa["RTN"];
    document.getElementById('correo').textContent = empresa["CORREO ELECTRONICO"];
    document.getElementById('telefono').textContent = empresa["TELEFONO"];
    document.getElementById('direccion').textContent = empresa["DIRECCION DE MI NEGOCIO"];

    // Consulta datos de ventas (VENTA)
    const resVenta = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableVenta}/Action`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ApplicationAccessKey': apiKey
      },
      body: JSON.stringify({ Action: "Find", Properties: {}, Rows: [] })
    });
    const data = await resVenta.json();

    // Filtrar entre fechas si ambas están definidas
    let ventas = data;
    if (desde && hasta) {
      const d = new Date(desde);
      const h = new Date(hasta);
      h.setDate(h.getDate() + 1);
      ventas = data.filter(v => {
        const f = new Date(v.FECHA);
        return f >= d && f < h;
      });
    } else {
      ventas = []; // si no hay fechas, mostrar en blanco
    }
  // Filtrar solo ventas con TIPO DE DOCUMENTO 'EMITIDA'
  ventas = ventas.filter(v => v["TIPO DE DOCUMENTO"] === "EMITIDA");
  // Ordenar ventas por fecha ascendente
  ventas.sort((a, b) => new Date(a.FECHA) - new Date(b.FECHA));

    if (ventas.length === 0) {
      contenedor.innerHTML = "<p>No hay ventas registradas en el rango seleccionado.</p>";
      return;
    }

    // Verificar si existe la columna 'isv4' en los datos
    const tieneISV4 = ventas.some(v => v.hasOwnProperty('isv4'));
    let totalVentas = 0, totalExonerado = 0, totalExento = 0, totalGravado = 0, totalISV15 = 0, totalISV18 = 0, totalISV4 = 0;
    const filas = ventas.map(v => {
      const exonerado = parseFloat(v["SUB EXONERADO"]) || 0;
      const exento = parseFloat(v["SUB EXENT"]) || 0;
      const gravado = parseFloat(v["SUB GRAVADO"]) || 0;
      const isv15 = gravado * 0.15;
      const isv18 = parseFloat(v["ISV (18%)"]) || 0;
      const isv4 = tieneISV4 ? (parseFloat(v["isv4"]) || 0) : null;
      const total = parseFloat(v["VENTA TOTAL"]) || 0;
      totalExonerado += exonerado;
      totalExento += exento;
      totalGravado += gravado;
      totalISV15 += isv15;
      totalISV18 += isv18;
      if (tieneISV4 && isv4 !== null) totalISV4 += isv4;
      totalVentas += total;
      // Formatear fecha a dd/mm/aaaa
      let fechaFormateada = '';
      if (v.FECHA) {
        const fechaObj = new Date(v.FECHA);
        const dia = String(fechaObj.getDate()).padStart(2, '0');
        const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
        const anio = fechaObj.getFullYear();
        fechaFormateada = `${dia}/${mes}/${anio}`;
      }
      return `<tr>
        <td>${fechaFormateada}</td>
        <td>${v.FACTURA || ''}</td>
        <td>${v.CLIENTE || ''}</td>
        <td>${v.IDENTIDAD || ''}</td>
        <td>${v["lista de productos"] || ''}</td>
        <td>${v["CANTIDAD DE PRODUCTO"] || ''}</td>
        <td>${exonerado.toFixed(2)}</td>
        <td>${exento.toFixed(2)}</td>
        <td>${gravado.toFixed(2)}</td>
        <td>${isv15.toFixed(2)}</td>
        <td>${isv18.toFixed(2)}</td>
        ${tieneISV4 ? `<td>${isv4 !== null ? isv4.toFixed(2) : '0.00'}</td>` : ''}
        <td>${total.toFixed(2)}</td>
        <td>${v.TIPO_PAGO || ''}</td>
        <td>${v["TIPO DE DOCUMENTO"] || ''}</td>
      </tr>`;
    }).join("");

    // Fila de totales
    const filaTotales = `<tr class="total-row">
      <td></td> <!-- FECHA -->
      <td></td> <!-- FACTURA -->
      <td></td> <!-- CLIENTE -->
      <td></td> <!-- IDENTIDAD -->
      <td></td> <!-- PRODUCTO -->
      <td></td> <!-- CANTIDAD -->
      <td>${totalExonerado.toFixed(2)}</td>
      <td>${totalExento.toFixed(2)}</td>
      <td>${totalGravado.toFixed(2)}</td>
      <td>${totalISV15.toFixed(2)}</td>
      <td>${totalISV18.toFixed(2)}</td>
      ${tieneISV4 ? `<td>${totalISV4.toFixed(2)}</td>` : ''}
      <td>${totalVentas.toFixed(2)}</td>
      <td></td> <!-- FORMA DE PAGO -->
      <td></td> <!-- TIPO DOC -->
    </tr>`;

    contenedor.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>FECHA</th><th>FACTURA</th><th>CLIENTE</th>
            <th>IDENTIDAD</th><th>PRODUCTO</th><th>CANTIDAD</th><th>SUB EXONERADO</th>
            <th>SUB EXENTO</th><th>SUB GRAVADO</th><th>ISV (15%)</th><th>ISV (18%)</th>
            ${tieneISV4 ? '<th>tas turistica (4%)</th>' : ''}
            <th>TOTAL</th><th>FORMA DE PAGO</th><th>TIPO DOC</th>
          </tr>
        </thead>
        <tbody>${filas + filaTotales}</tbody>
      </table>
      <div class="totales">
        <p>Total registros: ${ventas.length}</p>
        <p><span style="color:#6A1B9A">SUMAS:</span> EXONERADO: <b>L. ${totalExonerado.toFixed(2)}</b> | SUB EXENTO: <b>L. ${totalExento.toFixed(2)}</b> | SUB GRAVADO: <b>L. ${totalGravado.toFixed(2)}</b> | ISV (15%): <b>L. ${totalISV15.toFixed(2)}</b> | ISV (18%): <b>L. ${totalISV18.toFixed(2)}</b> ${tieneISV4 ? `| TAS TURISTICA (4%): <b>L. ${totalISV4.toFixed(2)}</b>` : ''} | <span style="color:#4A148C">TOTAL: <b>L. ${totalVentas.toFixed(2)}</b></span></p>
      </div>
    `;
  } // <-- Add this closing brace to properly end the try block
  catch (error) {
    contenedor.innerHTML = `<p>Error al cargar el reporte: ${error.message}</p>`;
  }
}
</script>
</body>
</html>
